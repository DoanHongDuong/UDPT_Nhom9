<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - Distributed System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f8fa;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #007bff;
    }

    section {
      background: white;
      padding: 20px;
      margin: 20px auto;
      width: 80%;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #nodeStatus div {
      padding: 10px;
      margin: 5px;
      border-radius: 6px;
      display: inline-block;
      width: 120px;
      text-align: center;
      color: white;
    }

    .node-up {
      background-color: #28a745;
    }

    .node-up.primary {
      background-color: #007bff;
      border: 2px solid #0056b3;
    }

    .node-down {
      background-color: #dc3545;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }

    input {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      padding: 8px 15px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin: 2px;

    }

    button.edit {
      background-color: #ffc107;
    }

    button.cancel {
      background-color: #6c757d;
    }


    .search-box {
      margin-bottom: 10px;
    }

    .search-box input {
      margin-right: 5px;
    }

    .search-box button {
      margin-right: 5px;
      background-color: #17a2b8;
    }

    .search-box button.reset {
      background-color: #6c757d;
    }


    #notification {
      width: 80%;
      margin: 10px auto;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      transition: opacity 0.5s ease;
      display: none;
    }

    #notification.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    #notification.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    #logBox {
      background-color: #f1f1f1;
      padding: 15px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
      color: #444;
    }

    .log-entry {
      margin: 5px 0;
      border-bottom: 1px dashed #ccc;
      padding-bottom: 5px;
    }

    footer {
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>Dashboard - Hệ thống phân tán</h1>

  <section id="nodes">
    <h2>Trạng thái Node</h2>
    <div id="nodeStatus"></div>
  </section>

  <section id="notification"></section>

  <section id="users">
    <h2>Danh sách người dùng</h2>

    <div class="search-box">
      <input id="search_name" type="text" placeholder="Tìm theo tên...">
      <button onclick="searchUsers()">Tìm kiếm</button>
      <button onclick="loadUsers()" class="reset">Hiện tất cả</button>
    </div>

    <table id="userTable">
      <thead>
        <tr>
          <th>Tên</th>
          <th>Email</th>
          <th>ID (UUID)</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3 id="formTitle">Thêm người dùng mới</h3>
    <input id="user_id" type="hidden"> <input id="name" type="text" placeholder="Tên người dùng">
    <input id="email" type="email" placeholder="Email">
    <button id="btnSubmit" onclick="submitUserForm()">Thêm</button>
    <button id="btnCancel" onclick="cancelEdit()" class="cancel" style="display:none;">Hủy</button>
  </section>

  <section id="logs">
    <h2>Nhật ký hoạt động</h2>
    <div id="logBox"></div>
  </section>
  <footer>
    <p>Bài tập lớn Ứng dụng phân tán</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      refreshAll();

      // Làm mới dashboard mỗi 3 giây
      setInterval(refreshAll, 3000);

      document.getElementById('search_name').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchUsers();
        }
      });

      loadUsers();
    });

    function refreshAll() {
      loadNodes();
      loadLogs();
    }

    // Load trạng thái node 
    function loadNodes() {
      fetch('/api/nodes')
        .then(res => res.json())
        .then(nodes => {
          const container = document.getElementById('nodeStatus');
          container.innerHTML = '';
          nodes.forEach(node => {
            const div = document.createElement('div');
            let statusClass = node.alive ? 'node-up' : 'node-down';
            if (node.role === 'PRIMARY') {
              statusClass += ' primary';
            }
            div.className = statusClass;
            div.textContent = `${node.name} (${node.role})`;
            container.appendChild(div);
          });
        })
        .catch(() => addLog("Không thể tải trạng thái node!"));
    }

    function updateTable(data) {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      if (data.users && data.users.length > 0) {
        data.users.forEach(u => {
          const row = document.createElement('tr');

          // Xử lý tên và email để tránh lỗi HTML nếu có dấu nháy
          const safeName = u.name ? u.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
          const safeEmail = u.email ? u.email.replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

          row.innerHTML = `
                        <td>${u.name || 'N/A'}</td>
                        <td>${u.email || 'N/A'}</td>
                        <td>${u.id}</td>
                        <td>
                            <button class="edit" onclick="showEditForm('${u.id}', '${safeName}', '${safeEmail}')">Sửa</button>
                            </td>
                    `;
          tbody.appendChild(row);
        });
      } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="4">Không tìm thấy người dùng nào.</td>`;
        tbody.appendChild(row);
      }
    }
    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          updateTable(data);
          document.getElementById('search_name').value = '';
          cancelEdit(); // Đảm bảo form được reset
        })
        .catch(() => addLog("Không thể tải danh sách người dùng!"));
    }

    // Tìm kiếm người dùng
    function searchUsers() {
      const name = document.getElementById('search_name').value.trim();
      if (!name) {
        loadUsers();
        return;
      }
      const params = new URLSearchParams({ name: name });
      fetch(`/api/search_users?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          updateTable(data);
        })
        .catch(() => addLog("Lỗi khi tìm kiếm người dùng!"));
    }

    // Load logs từ server 
    function loadLogs() {
      fetch('/api/logs')
        .then(res => res.json())
        .then(logs => {
          const logBox = document.getElementById('logBox');
          logBox.innerHTML = '';
          logs.forEach(l => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${l.time}] [${l.role}] ${l.event}`;
            logBox.appendChild(entry);
          });
        })
        .catch(() => addLog("Không thể tải logs từ server."));
    }

    function submitUserForm() {
      const userId = document.getElementById('user_id').value;
      if (userId) {
        saveUpdate(userId);
      } else {
        addUser();
      }
    }

    function addUser() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !email) {
        showNotification("Vui lòng nhập đầy đủ tên và email!", "error");
        return;
      }

      fetch('/api/add_user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email })
      })
        .then(handleFetchResponse)
        .then(data => {
          showNotification("Thêm người dùng thành công!", "success");
          addLog(`Đã thêm người dùng: ${name} (${email})`);
          loadUsers(); // Tự động reset form
        })
        .catch(handleFetchError);
    }

    function showEditForm(id, name, email) {
      document.getElementById('formTitle').textContent = "Cập nhật người dùng";
      document.getElementById('user_id').value = id;
      document.getElementById('name').value = name;
      document.getElementById('email').value = email;
      document.getElementById('btnSubmit').textContent = "Lưu thay đổi";
      document.getElementById('btnCancel').style.display = 'inline-block';

      // Cuộn đến form để người dùng thấy
      document.getElementById('formTitle').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
      document.getElementById('formTitle').textContent = "Thêm người dùng mới";
      document.getElementById('user_id').value = '';
      document.getElementById('name').value = '';
      document.getElementById('email').value = '';
      document.getElementById('btnSubmit').textContent = "Thêm";
      document.getElementById('btnCancel').style.display = 'none';
    }

    function saveUpdate(id) {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !email) {
        showNotification("Vui lòng nhập đầy đủ tên và email!", "error");
        return;
      }

      fetch('/api/update_user', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, name: name, email: email })
      })
        .then(handleFetchResponse)
        .then(data => {
          showNotification("Cập nhật người dùng thành công!", "success");
          addLog(`Đã cập nhật user ID: ${id}`);
          loadUsers();
        })
        .catch(handleFetchError);
    }

    function handleFetchResponse(res) {
      if (!res.ok) {
        return res.json().then(errData => {
          throw new Error(errData.error || `HTTP error! status: ${res.status}`);
        }).catch(() => {
          throw new Error(`HTTP error! status: ${res.status}`);
        });
      }
      return res.json();
    }

    // --- HELPER MỚI: Xử lý Lỗi (tránh lặp code) ---
    function handleFetchError(error) {
      const msg = error.message.includes("Failed to fetch") ? "Không thể kết nối tới server! Vui lòng thử lại." : error.message;
      showNotification("Lỗi: " + msg, "error");
      addLog("Lỗi thao tác: " + error.message);
    }


    // Hiển thị thông báo
    function showNotification(message, type) {
      const box = document.getElementById('notification');
      box.textContent = message;
      box.className = type;
      box.style.display = 'block';
      box.style.opacity = '1';
      setTimeout(() => {
        box.style.opacity = '0';
        setTimeout(() => { box.style.display = 'none'; }, 500);
      }, 4000);
    }

    // Thêm log (phía client) 
    function addLog(message) {
      const logBox = document.getElementById('logBox');
      const entry = document.createElement('div');
      const now = new Date().toLocaleTimeString();
      entry.className = 'log-entry client-log';
      entry.textContent = `[${now}] [CLIENT] ${message}`;
      logBox.prepend(entry);
    }

  </script>

</body>

</html>