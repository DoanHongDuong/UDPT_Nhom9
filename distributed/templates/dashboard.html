<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - Distributed System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f8fa;
      padding: 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #007bff;
    }

    section {
      background: white;
      padding: 20px;
      margin: 20px auto;
      width: 80%;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #nodeStatus div {
      padding: 10px;
      margin: 5px;
      border-radius: 6px;
      display: inline-block;
      width: 120px;
      text-align: center;
      color: white;
    }

    .node-up {
      background-color: #28a745;
    }

    .node-up.primary {
      background-color: #007bff;
      border: 2px solid #0056b3;
    }

    .node-down {
      background-color: #dc3545;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      /* Thêm khoảng cách */
    }

    th,
    td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }

    input {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      padding: 8px 15px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .search-box {
      margin-bottom: 10px;
    }

    .search-box input {
      margin-right: 5px;
    }

    .search-box button {
      margin-right: 5px;
      background-color: #17a2b8;
    }

    .search-box button.reset {
      background-color: #6c757d;
    }


    #notification {
      width: 80%;
      margin: 10px auto;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      transition: opacity 0.5s ease;
      display: none;
    }

    #notification.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    #notification.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    #logBox {
      background-color: #f1f1f1;
      padding: 15px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
      color: #444;
    }

    .log-entry {
      margin: 5px 0;
      border-bottom: 1px dashed #ccc;
      padding-bottom: 5px;
    }

    footer {
      text-align: center;

    }
  </style>
</head>

<body>
  <h1>Dashboard - Hệ thống phân tán</h1>

  <section id="nodes">
    <h2>Trạng thái Node</h2>
    <div id="nodeStatus"></div>
  </section>

  <section id="notification"></section>

  <section id="users">
    <h2>Danh sách người dùng</h2>

    <div class="search-box">
      <input id="search_name" type="text" placeholder="Tìm theo tên...">
      <button onclick="searchUsers()">Tìm kiếm</button>
      <button onclick="loadUsers()" class="reset">Hiện tất cả</button>
    </div>

    <table id="userTable">
      <thead>
        <tr>
          <th>Tên</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Thêm người dùng mới</h3>
    <input id="name" type="text" placeholder="Tên người dùng">
    <input id="email" type="email" placeholder="Email">
    <button onclick="addUser()">Thêm</button>
  </section>

  <section id="logs">
    <h2>Nhật ký hoạt động</h2>
    <div id="logBox"></div>
  </section>
  <footer>
    <p>Bài tập lớn Ứng dụng phân tán</p>
  </footer>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      refreshAll();

      // Làm mới dashboard mỗi 3 giây
      setInterval(refreshAll, 3000);

      // THÊM MỚI: Thêm sự kiện nhấn Enter cho ô tìm kiếm
      document.getElementById('search_name').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchUsers();
        }
      });

      // Tải danh sách users lần đầu khi mở trang
      loadUsers();
    });

    function refreshAll() {
      loadNodes();
      loadLogs();
    }

    // Load trạng thái node 
    function loadNodes() {
      fetch('/api/nodes')
        .then(res => res.json())
        .then(nodes => {
          const container = document.getElementById('nodeStatus');
          container.innerHTML = '';
          nodes.forEach(node => {
            const div = document.createElement('div');

            let statusClass = node.alive ? 'node-up' : 'node-down';
            if (node.role === 'PRIMARY') {
              statusClass += ' primary';
            }

            div.className = statusClass;
            div.textContent = `${node.name} (${node.role})`; // Hiển thị tên và vai trò
            container.appendChild(div);
          });
        })
        .catch(() => addLog("Không thể tải trạng thái node!"));
    }

    function updateTable(data) {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      if (data.users && data.users.length > 0) {
        data.users.forEach(u => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${u.name}</td><td>${u.email}</td>`;
          tbody.appendChild(row);
        });
      } else {
        // Hiển thị thông báo không tìm thấy
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="2">Không tìm thấy người dùng nào.</td>`;
        tbody.appendChild(row);
      }
    }

    // Load tất cả người dùng (nút "Hiện tất cả")
    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(data => {
          updateTable(data); // Gọi hàm helper
          document.getElementById('search_name').value = ''; // Xóa nội dung ô tìm kiếm
        })
        .catch(() => addLog("Không thể tải danh sách người dùng!"));
    }
    // Tìm kiếm người dùng (nút "Tìm kiếm")
    function searchUsers() {
      const name = document.getElementById('search_name').value.trim();
      if (!name) {
        // Nếu ô tìm kiếm rỗng, cứ tải tất cả
        loadUsers();
        return;
      }

      // Tạo URL an toàn với query parameter
      const params = new URLSearchParams({ name: name });

      fetch(`/api/search_users?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          updateTable(data);
        })
        .catch(() => addLog("Lỗi khi tìm kiếm người dùng!"));
    }
    // Load logs từ server 
    function loadLogs() {
      fetch('/api/logs')
        .then(res => res.json())
        .then(logs => {
          const logBox = document.getElementById('logBox');
          logBox.innerHTML = ''; // Xóa log cũ
          logs.forEach(l => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            // Định dạng log mới từ server python
            entry.textContent = `[${l.time}] [${l.role}] ${l.event}`;
            logBox.appendChild(entry); // Dùng append để giữ đúng thứ tự (cũ nhất ở trên)
          });
        })
        .catch(() => addLog("Không thể tải logs từ server.")); // <-- SỬA DÒNG NÀY (sửa từ console.error sang addLog)
    }

    // Thêm người dùng (Giữ nguyên)
    function addUser() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!name || !email) {
        showNotification("Vui lòng nhập đầy đủ tên và email!", "error");
        return;
      }

      fetch('/api/add_user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email })
      })
        .then(res => {
          // Kiểm tra nếu server trả về lỗi (ví dụ 503, 504)
          if (!res.ok) {
            // Ném lỗi để nhảy xuống .catch
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.error) {
            showNotification("Lỗi: " + data.error, "error");
            addLog("Lỗi thêm người dùng: " + data.error);
          } else {
            showNotification("Thêm người dùng thành công!", "success");
            addLog(`Đã thêm người dùng: ${name} (${email})`);
            loadUsers(); // Tải lại danh sách user sau khi thêm
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
          }
        })
        .catch((error) => {
          showNotification("Không thể kết nối tới server! Vui lòng thử lại.", "error");
          addLog("Kết nối server thất bại khi thêm người dùng. " + error.message);
        });
    }

    // Hiển thị thông báo (Giữ nguyên)
    function showNotification(message, type) {
      const box = document.getElementById('notification');
      box.textContent = message;
      box.className = type;
      box.style.display = 'block';
      box.style.opacity = '1';
      setTimeout(() => {
        box.style.opacity = '0';
        setTimeout(() => { box.style.display = 'none'; }, 500);
      }, 4000);
    }

    // Thêm log (phía client) 
    function addLog(message) {
      const logBox = document.getElementById('logBox');
      const entry = document.createElement('div');
      const now = new Date().toLocaleTimeString();
      entry.className = 'log-entry client-log';
      entry.textContent = `[${now}] [CLIENT] ${message}`;
      logBox.prepend(entry);
    }

  </script>

</body>

</html>